parameters:
  ghprbPullId: ''
  Operation: ''
  wcfPRServiceUri: "http://wcfcoresrv2.cloudapp.net/PRServiceMaster/pr.ashx"
  wcfPRServiceId: ''
  sourceBranch: $(Build.SourceBranch)

steps:
    # Get the PR ID or Branch name, the Service will sync to whichever is provided. - Windows
  - script: |
      if not "%Operation%"=="branch" if not "%Operation%"=="pr" (
        echo Operation mode was set to: %Operation%
        echo Invalid operation mode specified.
        set _EXITCODE=1
        goto done
      )
      if '%Operation%'=='pr' (
        echo Operation is set to: %Operation%
        goto pr
      )
      if '%Operation%'=='branch' (
        echo Operation is set to: %Operation%
        goto branch
      )

      :pr
      echo Parse the PR ID from environment variable 'Build.SourceBranch': %SOURCEBRANCH%
      set GHPRBPULLID=%SOURCEBRANCH:refs/pull/=%
      set GHPRBPULLID=%GHPRBPULLID:/merge=%
      echo The PR ID is: %GHPRBPULLID%
      goto done

      :branch
      echo Set the repo branch to be what build.SourceBranchName is: %BUILD_SOURCEBRANCHNAME%
      REM The following vso call sets a variable that is accessible further down in the PowerShell script to Sync the PR Service.
      echo ##vso[task.setvariable variable=branchName]%BUILD_SOURCEBRANCHNAME%
      goto done

      :done
      exit /b %_EXITCODE%

    displayName: Set_Operation_PR_or_Branch_Windows
    env:
      GHPRBPULLID: ${{ parameters.ghprbPullId }}
      SOURCEBRANCH: ${{ parameters.sourceBranch }}
    condition: and(always(), eq(variables['Agent.Os'], 'Windows_NT'), eq(variables['_UpdateService'], 'true'))
    # Get the PR ID or Branch name, the Service will sync to whichever is provided. - Unix
  - bash: |
      if [ $Operation -ne "branch" ] || [ $Operation -ne "pr" ]; then
        echo "Operation mode was set to: $Operation"
        echo "Invalid operation mode specified."
        exit -1
      fi

      if [ $Operation -eq "pr" ]; then
        echo "Operation is set to: $Operation"
        echo "Parse the PR ID from environment variable 'Build.SourceBranch': $SOURCEBRANCH"
        split($SOURCEBRANCH, a, "/", seps)
        $GHPRBPULLID=$a[3]
        echo "The PR ID is: $GHPRBPULLID"
      fi

      if [ $Operation -eq "branch" ]; then
        echo "Operation is set to: $Operation"
        echo "Set the repo branch to be what build.SourceBranchName is: $BUILD_SOURCEBRANCHNAME"
        echo "##vso[task.setvariable variable=branchName]%BUILD_SOURCEBRANCHNAME%"
      fi

    displayName: Set_Operation_PR_or_Branch_Unix
    env:
      GHPRBPULLID: ${{ parameters.ghprbPullId }}
      SOURCEBRANCH: ${{ parameters.sourceBranch }}
    condition: and(always(), ne(variables['Agent.Os'], 'Windows_NT'), eq(variables['_UpdateService'], 'true'))
    # Sync the Service to the PR on Windows.
  - powershell: |
      Write-Host "The WCF Root dir is: $env:Build_SourcesDirectory"
      Write-Host "Variable wcfPRServiceId is set to: $env:WCFPRSERVICEID"
      Write-Host "Variable Operation is set to: $env:Operation"
      Write-Host "Variable wcfPRServiceUri is set to: $env:WCFPRSERVICEURI"
      Write-Host "Variable branchName is set to: $env:branchName"
      invoke-command -Scriptblock { & "$env:Build_SourcesDirectory\src\System.Private.ServiceModel\tools\scripts\sync-pr.cmd "$env:WCFPRSERVICEID $env:Operation $env:WCFPRSERVICEURI $env:branchName"" }
      $LASTEXITCODE

    displayName: Sync_PRService
    env:
      WCFPRSERVICEURI: ${{ parameters.wcfPRServiceUri }}
      WCFPRSERVICEID: ${{ parameters.wcfPRServiceId }}
    condition: and(always(), eq(variables['Agent.Os'], 'Windows_NT'), eq(variables['_UpdateService'], 'true'))
